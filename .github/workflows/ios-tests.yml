name: iOS Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * *'  # Nightly full test run with coverage

jobs:
  ios-tests:
    name: iOS Tests (Faster + Stable)
    runs-on: macos-15
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone workoutkit-sync dependency
        run: git clone https://github.com/supergeri/workoutkit-sync.git ../../workoutkit-sync

      - name: Select Xcode (prefer stable 16.x)
        id: xcode
        run: |
          # Prefer stable Xcode 16.x if present, otherwise fall back to latest installed
          XCODE_PATH=$(ls -d /Applications/Xcode_16*.app 2>/dev/null | sort -V | tail -1)
          if [ -z "$XCODE_PATH" ]; then
            XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          fi
          echo "Using Xcode: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH"
          XCODE_VER=$(xcodebuild -version | head -1 | tr ' ' '-')
          echo "version=$XCODE_VER" >> $GITHUB_OUTPUT

      - name: Determine simulator (prefer iPhone 15 Pro)
        id: simulator
        run: |
          if xcrun simctl list devices available | grep -q "iPhone 15 Pro"; then
            echo "name=iPhone 15 Pro" >> $GITHUB_OUTPUT
          elif xcrun simctl list devices available | grep -q "iPhone 16"; then
            echo "name=iPhone 16" >> $GITHUB_OUTPUT
          else
            echo "name=iPhone" >> $GITHUB_OUTPUT
          fi

      - name: Reset simulators (avoid instruments lockdown timeouts)
        run: |
          xcrun simctl shutdown all || true
          xcrun simctl erase all || true

      - name: Create stub TestCredentials for compilation
        working-directory: AmakaFlowCompanion
        run: |
          cat > AmakaFlowCompanionUITests/TestCredentials.swift << 'EOF'
          import Foundation
          enum TestCredentials {
              static let testAuthSecret = "ci-stub-not-for-testing"
              static let userId = "ci_stub_user"
              static let userEmail = "ci@stub.local"
              static let userName = "CI Stub"
              static let apiBaseURL = "http://localhost:8001"
          }
          EOF

      # -----------------------------
      # Cache RESTORE (must happen BEFORE resolve/build)
      # -----------------------------
      - name: Restore SwiftPM cache
        uses: actions/cache@v4
        with:
          path: AmakaFlowCompanion/.spm
          key: spm-${{ runner.os }}-${{ steps.xcode.outputs.version }}-${{ hashFiles('**/Package.resolved', 'AmakaFlowCompanion/AmakaFlowCompanion.xcodeproj/project.pbxproj') }}
          restore-keys: |
            spm-${{ runner.os }}-${{ steps.xcode.outputs.version }}-

      - name: Restore DerivedData cache
        uses: actions/cache@v4
        with:
          path: AmakaFlowCompanion/DerivedData
          key: deriveddata-${{ runner.os }}-${{ steps.xcode.outputs.version }}-${{ hashFiles('AmakaFlowCompanion/AmakaFlowCompanion.xcodeproj/project.pbxproj', 'AmakaFlow/**/*.swift', 'AmakaFlowCompanion/**/*.swift') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-${{ steps.xcode.outputs.version }}-

      # -----------------------------
      # SwiftPM Resolve (fast if cache hit)
      # -----------------------------
      - name: Resolve SwiftPM dependencies
        working-directory: AmakaFlowCompanion
        run: |
          xcodebuild -resolvePackageDependencies \
            -project AmakaFlowCompanion.xcodeproj \
            -scheme AmakaFlowCompanion \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath .spm

      # -----------------------------
      # Build for Testing
      # -----------------------------
      - name: Build for testing
        working-directory: AmakaFlowCompanion
        run: |
          xcodebuild build-for-testing \
            -project AmakaFlowCompanion.xcodeproj \
            -scheme AmakaFlowCompanion \
            -destination "platform=iOS Simulator,name=${{ steps.simulator.outputs.name }}" \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath .spm \
            -parallelizeTargets \
            -jobs $(sysctl -n hw.ncpu)

      # -----------------------------
      # Run Tests (limit concurrency to avoid clone timeouts)
      # -----------------------------
      - name: Run tests
        working-directory: AmakaFlowCompanion
        run: |
          COVERAGE_FLAG="NO"
          if [ "${{ github.event_name }}" = "schedule" ]; then
            COVERAGE_FLAG="YES"
          fi

          set +e
          xcodebuild test-without-building \
            -project AmakaFlowCompanion.xcodeproj \
            -scheme AmakaFlowCompanion \
            -destination "platform=iOS Simulator,name=${{ steps.simulator.outputs.name }}" \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath .spm \
            -only-testing:AmakaFlowCompanionTests \
            -resultBundlePath TestResults \
            -enableCodeCoverage $COVERAGE_FLAG \
            -parallel-testing-enabled YES \
            -parallel-testing-worker-count 2 \
            -maximum-concurrent-test-simulator-destinations 2 \
            -parallelizeTargets \
            -jobs $(sysctl -n hw.ncpu) 2>&1 | tee test_output.log
          XCODE_EXIT=${PIPESTATUS[0]}
          set -e

          if grep -q "with 0 failures (0 unexpected)" test_output.log; then
            echo "All tests passed!"
            exit 0
          elif grep -q "TEST SUCCEEDED" test_output.log; then
            echo "All tests passed!"
            exit 0
          elif grep -q "with [1-9][0-9]* failures" test_output.log; then
            echo "Tests failed!"
            grep "failures" test_output.log | tail -5
            exit 1
          else
            echo "Using xcodebuild exit code: $XCODE_EXIT"
            tail -60 test_output.log
            exit $XCODE_EXIT
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: AmakaFlowCompanion/TestResults
          retention-days: 7
