name: iOS & watchOS Tests

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 6 * * *'  # Nightly full test run with coverage
  workflow_dispatch:  # Manual trigger option

jobs:
  ios-tests:
    name: iOS Tests (Faster + Stable)
    # Note: macos-15-xlarge (Apple Silicon) would be 3-4x faster but requires billing upgrade
    runs-on: macos-15
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone workoutkit-sync dependency
        run: git clone https://github.com/supergeri/workoutkit-sync.git ../../workoutkit-sync

      - name: Select Xcode (latest available)
        id: xcode
        run: |
          # Use latest Xcode - project requires iOS 18.6+/watchOS 11.6 which needs Xcode 26.x
          XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          echo "Using Xcode: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH"
          XCODE_VER=$(xcodebuild -version | head -1 | tr ' ' '-')
          echo "version=$XCODE_VER" >> $GITHUB_OUTPUT

      - name: Determine simulator (first available iPhone)
        id: simulator
        run: |
          # Extract first iPhone device name from available simulators
          # Format: "    iPhone 17 Pro (UUID) (Shutdown)"
          NAME=$(xcrun simctl list devices available | grep -o 'iPhone [^(]*' | head -1 | sed 's/ *$//')
          if [ -z "$NAME" ]; then
            echo "No available iPhone simulator found" >&2
            xcrun simctl list devices available
            exit 1
          fi
          echo "Using simulator: $NAME"
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: Reset simulators (avoid instruments lockdown timeouts)
        run: |
          xcrun simctl shutdown all || true
          xcrun simctl erase all || true

      - name: Create stub TestCredentials for compilation
        working-directory: AmakaFlowCompanion
        run: |
          cat > AmakaFlowCompanionUITests/TestCredentials.swift << 'EOF'
          import Foundation
          enum TestCredentials {
              static let testAuthSecret = "ci-stub-not-for-testing"
              static let userId = "ci_stub_user"
              static let userEmail = "ci@stub.local"
              static let userName = "CI Stub"
              static let apiBaseURL = "http://localhost:8001"
          }
          EOF

      # -----------------------------
      # Cache RESTORE (must happen BEFORE resolve/build)
      # -----------------------------
      - name: Restore SwiftPM cache
        uses: actions/cache@v4
        with:
          path: AmakaFlowCompanion/.spm
          key: spm-${{ runner.os }}-${{ steps.xcode.outputs.version }}-${{ hashFiles('**/Package.resolved', 'AmakaFlowCompanion/AmakaFlowCompanion.xcodeproj/project.pbxproj') }}
          restore-keys: |
            spm-${{ runner.os }}-${{ steps.xcode.outputs.version }}-

      - name: Restore DerivedData cache
        uses: actions/cache@v4
        with:
          path: AmakaFlowCompanion/DerivedData
          key: deriveddata-${{ runner.os }}-${{ steps.xcode.outputs.version }}-${{ hashFiles('AmakaFlowCompanion/AmakaFlowCompanion.xcodeproj/project.pbxproj', 'AmakaFlow/**/*.swift', 'AmakaFlowCompanion/**/*.swift') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-${{ steps.xcode.outputs.version }}-

      # -----------------------------
      # SwiftPM Resolve (fast if cache hit)
      # -----------------------------
      - name: Resolve SwiftPM dependencies
        working-directory: AmakaFlowCompanion
        run: |
          xcodebuild -resolvePackageDependencies \
            -project AmakaFlowCompanion.xcodeproj \
            -scheme AmakaFlowCompanion \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath .spm

      - name: Debug cache status
        working-directory: AmakaFlowCompanion
        run: |
          echo "=== .spm cache status ==="
          ls -la .spm 2>/dev/null || echo ".spm directory not found (cache miss)"
          echo "=== DerivedData cache status ==="
          ls -la DerivedData 2>/dev/null | head -10 || echo "DerivedData directory not found (cache miss)"

      # -----------------------------
      # Build for Testing
      # -----------------------------
      - name: Build for testing
        working-directory: AmakaFlowCompanion
        run: |
          xcodebuild build-for-testing \
            -project AmakaFlowCompanion.xcodeproj \
            -scheme AmakaFlowCompanion \
            -destination "platform=iOS Simulator,name=${{ steps.simulator.outputs.name }}" \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath .spm \
            -parallelizeTargets \
            -jobs $(sysctl -n hw.ncpu)

      # -----------------------------
      # Run Tests (limit concurrency to avoid clone timeouts)
      # -----------------------------
      - name: Run tests
        working-directory: AmakaFlowCompanion
        run: |
          COVERAGE_FLAG="NO"
          if [ "${{ github.event_name }}" = "schedule" ]; then
            COVERAGE_FLAG="YES"
          fi

          set +e
          xcodebuild test-without-building \
            -project AmakaFlowCompanion.xcodeproj \
            -scheme AmakaFlowCompanion \
            -destination "platform=iOS Simulator,name=${{ steps.simulator.outputs.name }}" \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath .spm \
            -only-testing:AmakaFlowCompanionTests \
            -resultBundlePath TestResults \
            -enableCodeCoverage $COVERAGE_FLAG \
            -parallel-testing-enabled YES \
            -parallel-testing-worker-count 2 \
            -maximum-concurrent-test-simulator-destinations 2 \
            -parallelizeTargets \
            -jobs $(sysctl -n hw.ncpu) 2>&1 | tee test_output.log
          XCODE_EXIT=${PIPESTATUS[0]}
          set -e

          if grep -q "with 0 failures (0 unexpected)" test_output.log; then
            echo "All tests passed!"
            exit 0
          elif grep -q "TEST SUCCEEDED" test_output.log; then
            echo "All tests passed!"
            exit 0
          elif grep -q "with [1-9][0-9]* failures" test_output.log; then
            echo "Tests failed!"
            grep "failures" test_output.log | tail -5
            exit 1
          else
            echo "Using xcodebuild exit code: $XCODE_EXIT"
            tail -60 test_output.log
            exit $XCODE_EXIT
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-test-results
          path: AmakaFlowCompanion/TestResults
          retention-days: 7

  # ---------------------------------------------------------
  # watchOS Tests (runs in parallel with iOS tests)
  # Part of AMA-553: Watch app test automation coverage
  # ---------------------------------------------------------
  watchos-tests:
    name: watchOS Tests
    runs-on: macos-15
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone workoutkit-sync dependency
        run: git clone https://github.com/supergeri/workoutkit-sync.git ../../workoutkit-sync

      - name: Select Xcode (latest available)
        id: xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          echo "Using Xcode: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH"
          XCODE_VER=$(xcodebuild -version | head -1 | tr ' ' '-')
          echo "version=$XCODE_VER" >> $GITHUB_OUTPUT

      - name: Determine watch simulator (first available Apple Watch)
        id: watch-simulator
        run: |
          # Apple Watch names include size in parens, e.g. "Apple Watch Series 10 (46mm)"
          # Extract full name up to the UUID pattern
          NAME=$(xcrun simctl list devices available | grep 'Apple Watch' | head -1 | sed -E 's/^[[:space:]]*//' | sed -E 's/ \([0-9A-F]{8}-.*$//')
          if [ -z "$NAME" ]; then
            echo "No available Apple Watch simulator found" >&2
            xcrun simctl list devices available
            exit 1
          fi
          echo "Using watch simulator: $NAME"
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: Reset simulators
        run: |
          xcrun simctl shutdown all || true
          xcrun simctl erase all || true

      - name: Create stub TestCredentials for compilation
        working-directory: AmakaFlowCompanion
        run: |
          cat > AmakaFlowCompanionUITests/TestCredentials.swift << 'EOF'
          import Foundation
          enum TestCredentials {
              static let testAuthSecret = "ci-stub-not-for-testing"
              static let userId = "ci_stub_user"
              static let userEmail = "ci@stub.local"
              static let userName = "CI Stub"
              static let apiBaseURL = "http://localhost:8001"
          }
          EOF

      # -----------------------------
      # Cache RESTORE
      # -----------------------------
      - name: Restore SwiftPM cache
        uses: actions/cache@v4
        with:
          path: AmakaFlowCompanion/.spm
          key: spm-${{ runner.os }}-${{ steps.xcode.outputs.version }}-${{ hashFiles('**/Package.resolved', 'AmakaFlowCompanion/AmakaFlowCompanion.xcodeproj/project.pbxproj') }}
          restore-keys: |
            spm-${{ runner.os }}-${{ steps.xcode.outputs.version }}-

      - name: Restore DerivedData cache
        uses: actions/cache@v4
        with:
          path: AmakaFlowCompanion/DerivedData
          key: deriveddata-watchos-${{ runner.os }}-${{ steps.xcode.outputs.version }}-${{ hashFiles('AmakaFlowCompanion/AmakaFlowCompanion.xcodeproj/project.pbxproj', 'AmakaFlowCompanion/AmakaFlowWatch Watch App/**/*.swift') }}
          restore-keys: |
            deriveddata-watchos-${{ runner.os }}-${{ steps.xcode.outputs.version }}-

      # -----------------------------
      # SwiftPM Resolve
      # -----------------------------
      - name: Resolve SwiftPM dependencies
        working-directory: AmakaFlowCompanion
        run: |
          xcodebuild -resolvePackageDependencies \
            -project AmakaFlowCompanion.xcodeproj \
            -scheme "AmakaFlowWatch Watch App" \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath .spm

      # -----------------------------
      # Build watchOS tests
      # -----------------------------
      - name: Build watchOS tests
        working-directory: AmakaFlowCompanion
        run: |
          xcodebuild build-for-testing \
            -project AmakaFlowCompanion.xcodeproj \
            -scheme "AmakaFlowWatch Watch App" \
            -destination "platform=watchOS Simulator,name=${{ steps.watch-simulator.outputs.name }}" \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath .spm \
            -parallelizeTargets \
            -jobs $(sysctl -n hw.ncpu)

      # -----------------------------
      # Run watchOS unit tests
      # Note: watchOS UI tests (XCUITest) require the AX accessibility
      # framework which doesn't work on CI watchOS simulators
      # (kAXErrorCannotComplete). UI tests must be run locally.
      # -----------------------------
      - name: Run watchOS unit tests
        working-directory: AmakaFlowCompanion
        run: |
          set +e
          xcodebuild test-without-building \
            -project AmakaFlowCompanion.xcodeproj \
            -scheme "AmakaFlowWatch Watch App" \
            -destination "platform=watchOS Simulator,name=${{ steps.watch-simulator.outputs.name }}" \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath .spm \
            -only-testing:"AmakaFlowWatch Watch AppTests" \
            -resultBundlePath WatchTestResults \
            -enableCodeCoverage NO 2>&1 | tee watch_output.log
          XCODE_EXIT=${PIPESTATUS[0]}
          set -e

          if grep -q "TEST SUCCEEDED" watch_output.log || grep -q "with 0 failures" watch_output.log; then
            echo "watchOS unit tests passed!"
            exit 0
          fi
          exit $XCODE_EXIT

      - name: Upload watchOS test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: watchos-test-results
          path: AmakaFlowCompanion/WatchTestResults
          retention-days: 7
